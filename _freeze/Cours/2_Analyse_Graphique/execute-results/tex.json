{
  "hash": "7489577fc4c7d2a6e28b5f2783c2fae2",
  "result": {
    "markdown": "---\ntitle: \"2 - Analyse graphique\"\n---\n\n\n\n\n### Objectifs de cette séquence\n\nPrésenter différents outils permettant d'analyser les séries temporelles\n\n### Questions de positionnement\n\nQuelles sont les outils de visualisation possibles d'une série temporelle ?\n\nComment analyser la dépendance temporelle ?\n\nComment analyser la saisonnalité ?\n\nPourquoi il est parfois nécessaire de transformer une série ?\n\n# Analyse graphique\n\n## Chronogramme\n\nLa première analyse graphique possible est le chronogramme, permet :\n\n- avoir une vue d'ensemble\n\n- identifier des ruptures, points atypiques, valeurs manquantes\n\nSous {{< fa brands r-project >}} : `plot()` (=`plot.ts()`) ou `forecast::autoplot()` pour une version ggplot2.\n\n\nExemple avec le nombre mensuel de conducteurs de voitures tués en Grande-Bretagne entre 1969 et 1984.\n\n### Exemple (1)\n\n\\footnotesize\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(UKDriverDeaths,\n\t main = \"Nombre mensuel de conducteurs de voitures tués au RU\",\n\t ylab = \"Nombre\")\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-1-1.pdf)\n:::\n:::\n\n\n### Exemple (2)\n\n\\footnotesize\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(forecast);library(ggplot2)\nautoplot(UKDriverDeaths) +\n\tlabs(title = \"Nombre mensuel de conducteurs de voitures tués au RU\",\n\t\t y = \"Nombre\")\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-2-1.pdf)\n:::\n:::\n\n\n### Exemple (3)\n\n\\footnotesize\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(nottem) + \n\tggtitle(\"Température mensuelle moyenne au Château de Nottingham\") +\n\tylab(\"Degré Fahrenheit\")\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-3-1.pdf)\n:::\n:::\n\n\n\n\n## Les composantes d'une série temporelle\n\n\n### Les différentes composantes\n\nOn considère généralement qu'une série temporelle peut s'écrire en fonction de différentes composantes :  \n\n- tendance : évolution de long terme de la série\n\n- cycle : mouvement cyclique (d'au moins 2 ans) autour de la tendance à une à une fréquence non fixée\n\n- saisonnalité : fréquence fixe est connue (infra-annuelle)\n\n- les autres effets de calendrier (jours ouvrables, etc.)\n\n- irrégulier : composante d'erreur (idéalement faible)\n\n### Exemple {.allowframebreaks}\n\n\\footnotesize\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\n(\n\tautoplot(co2) + \n\t\tlabs(title = latex2exp::TeX(\"Concentration mensuelle en CO$_2$ à Mauna Loa\"),\n\t\t\t y = \"ppm\")  + \n\t\tautoplot(window(sunspots, start = 1900, end = 1930)) +\n\t\tlabs(title = \"Nombre mensuel de taches solaires\", y = \"Nombre\")\n) / (\n\tautoplot(austres) +\n\t\tlabs(title = \"Nombre trimestriel de résidents australiens\",\n\t\t\t y = \"milliers\") +\n\t\tautoplot(diff(EuStockMarkets[,\"CAC\"])) +\n\t\tlabs(title = \"Variations quotidiennes du cours\\nde clôture du CAC 40\",\n\t\t\t y = \"Variation dans les prix\")\n)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-4-1.pdf)\n:::\n:::\n\n\n\n## Monthplot\n\nPermet d'étudier le schéma saisonnier et l'évolution de la saisonnalité au cours du temps\n\n{{< fa brands r-project >}} : `monthplot()`, `forecast::ggmonthplot()` ou `feasts::gg_subseries()` pour la version tsibble.\n\n### Exemple (1)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmonthplot(nottem)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-5-1.pdf)\n:::\n:::\n\n\n### Exemple (2)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggmonthplot(nottem)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-6-1.pdf)\n:::\n:::\n\n\n## Seasonal plot\n\nPermet d'étudier le schéma saisonnier et les écarts importants par rapport à ce schéma\n\n{{< fa brands r-project >}} : `forecast::seasonplot()`, `forecast::ggseasonplot()` ou `feasts::gg_season()` pour la version tsibble.\n\n### Exemple\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggseasonplot(nottem)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-7-1.pdf)\n:::\n:::\n\n\n### Exemple : avec option `polar = TRUE`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggseasonplot(nottem, polar = TRUE)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-8-1.pdf){width=60%}\n:::\n:::\n\n\n\n## Lag plot\n\nPermet d'étudier la dépendance d'une série avec son passé\n\n{{< fa brands r-project >}} : `lag.plot()`, `forecast::gglagplot()` ou `feasts::gg_lag()` pour la version tsibble.\n\n### Exemple (1)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlag.plot(nottem, lags = 12)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-9-1.pdf)\n:::\n:::\n\n\n### Exemple (2)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngglagplot(nottem,lags  = 12)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-10-1.pdf){height=80%}\n:::\n:::\n\n\n### Analyse \n\n- Corrélation positive entre $X_t$ et $X_{t-1}$ : température du mois $t$ est proche de celle du mois précédent\n\n- Corrélation positive entre $X_t$ et $X_{t-12}$ : température du mois $t$ est proche de celle du mois $t$ de l'année précédente\n\n- Corrélation négative entre $X_t$ et $X_{t-6}$ : il y a des saisons\n\n- Anneaux pour les retards 2, 3, 4, 8, 9 et 10.\nEx pour les retards 3 : en avril/mai/juin la température est plus élevée que trois mois avant (au-dessus de la bissextrice)\n\n## ACF\n\nAutocorrélogrammes : autocorrélations associées aux graphiques précédents\n$$\n\\hat\\gamma(k) = \\frac{1}{n}\\sum_{t=k+1}^n(y_t-\\bar y)(y_{t-k}-\\bar y)\\text{ et }\\hat\\rho(k)=\\frac{\\hat\\gamma(k)}{\\hat\\gamma(0)}\n$$\n\nPermet d'identifier les tendances et la saisonnalité\n\n\n{{< fa brands r-project >}} : `acf()`, `forecast::ggAcf()` ou `autoplot(feast::ACF())` pour la version tsibble.\n\n<!-- {{< fa brands r-project >}} : `pacf()`  ou `forecast::ggPacf()` -->\n\n### Exemple (1)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nacf(nottem)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-11-1.pdf)\n:::\n:::\n\n\n### Exemple (2)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggAcf(nottem)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-12-1.pdf)\n:::\n:::\n\n\n\n### Exercice\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/quiz-acf-1.pdf)\n:::\n:::\n\n\n### Solution\n\n\\footnotesize\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 = autoplot(AirPassengers) + labs(y = \"Nombre\",\n\ttitle = \"1. Nombre de passagers aériens mensuel\")\nacf_c = ggAcf(AirPassengers) + labs(title = \"C.\", y = NULL)\np2 = autoplot(ldeaths) + labs(y = \"Nombre\",\n\ttitle = \"2. Nombre de décès de maladies pulmonaires au Royaume-Uni\")\nacf_a = ggAcf(ldeaths) + labs(title = \"A.\", y = NULL)\np3 = autoplot(UKDriverDeaths) + labs(y = \"Nombre\",\n\ttitle = \"3. Nombre de conducteurs de voitures tués au RU\")\nacf_b = ggAcf(UKDriverDeaths) + labs(title = \"B.\", y = NULL)\np4 = autoplot(UKgas) + labs(y = \"Nombre\",\n\ttitle = \"4. Consommation trimestrielle de gaz au Royaume-Uni\")\nacf_d = ggAcf(UKgas) + labs(title = \"D.\", y = NULL)\npatchwork::wrap_plots(p1, p2, p3, p4, acf_a, acf_b, acf_c, acf_d, \n\t\t\t\t\t  ncol = 2)\n```\n:::\n\n\n## Densité spectrale\n\n### Analyse spectrale\n\n**Représentation classique d'une série :** fluctuations de la série en fonction du temps…\n\n**Représentation spectrale :**\nune série peut être représentée dans le domaine des fréquences. Un spectre montre les fluctuations de la série par fréquence.\n$$\n\\text{fréquence}=\\frac{2\\pi}{\\text{période}}\n$$\nInterprétation : **décomposition de la variance de la série** selon les différentes fréquences\n\nDeux méthodes d'estimation : périodogramme et spectre autorégressif\n\nNB : fonctions définies à une constante multiplicative près\n\n### Périodogramme {.allowframebreaks}\n\nSous {{< fa brands r-project >}} :  `spec.pgram()` ou `spectrum(method = \"pgram\")`\n\nSoit $x_1,\\dots,x_n$ des observations d'une série temporelle. On suppose $x_1,\\dots,x_n$ les valeurs d'une fonction en $1, \\dots, n$ :\n$$\nx_t=\\frac{1}{\\sqrt{n}}\\sum_{\\pi<\\omega_j\\leq\\pi}a_je^{it\\omega_j},\\quad\\omega_j=\\frac{2\\pi j}{n}\n$$\nRmq : c'est bien possible d'écrire sous cette forme car $e_j=n^{-1/2}(e^{i\\omega_j},\\dots,e^{in\\omega_j})$ base orthonormée de $\\mathbb C^n$\n\nIl vient :\n$$\nx=\\sum_{j|\\pi<\\omega_j\\leq\\pi}a_je_j\\quad\\text{avec}\\quad\na_j=\\langle x, e_j \\rangle=\\frac{1}{\\sqrt{n}}\\sum_{t=1}^nx_te^{-it\\omega_j}\n$$\n\nLa valeur du périodogramme $I(\\omega_j)$ est :\n$$\nI(\\omega_j)\\colon=|a_j|^2=\\frac{1}{n}\\left|\\sum_{t=1}^nx_te^{-it\\omega_j}\n\\right|^2\n$$\nOn a donc une décomposition de la variance :\n$$\n||x||^2=\\sum I(\\omega_j)\n$$\n\nRmq : dans le cas réel, $I(\\omega_j) = I(-\\omega_j)$\n\nRmq : généralement $x$ est normalisé (en enlevant également la tendance)\n\nDonne les mêmes informations que les autocorrélogrammes :\n\n$$\nI(\\omega_j)=\\sum_{|k|<n}\\hat\\gamma(k)e^{-ik\\omega_j}\n$$\n\n### Exemple\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspec.pgram(nottem)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-14-1.pdf)\n:::\n:::\n\n\n### Périodogramme cumulatif Bartlett (1955)\n\nUn graphique dérivé est le périodogramme cumulatif\n$$\nU (\\omega) = \n\\frac{\\sum_{0<\\omega_k<\\omega}I(\\omega_k)}{\\sum I(\\omega_k)}\n$$\nPermet de détecter des mouvements périodiques non-aléatoires : on observe un saut s'il y a un mouvement périodic et une droite si proche d'un bruit blanc\n\n### Exemple\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(1,2))\ncpgram(nottem)\ncpgram(diff(nottem, 12))\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-15-1.pdf)\n:::\n:::\n\n\n\n### Spectre autorégressif\n\nSous {{< fa brands r-project >}} : `spec.ar()` ou `spectrum(method = \"ar\")`\n\nAutre méthode : calculer le spectre d'un processus AR : $X_t=\\phi_1 X_{t-1}+\\dots+\\phi_pX_{t-p}+\\varepsilon_t$\n$$\nf(\\omega) = \\sigma^2\\frac{1}{\n2\\pi\\left|\n1-\\sum_{j=1}^p\\phi_j e^{ij\\omega}\n\\right|^2\n}\n$$\nRmq : sous R $f(\\omega) = \\sigma^2\\frac{1}{freq\\left|1-\\sum_{j=1}^p\\phi_j e^{ij\\omega}\\right|^2}$\n\n\n### Exemple\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspec.ar(nottem)\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-16-1.pdf)\n:::\n:::\n\n\n### Exercice\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/quiz-spectre-1.pdf)\n:::\n:::\n\n\n### Solution\n\n\\scriptsize\n\n::: {.cell}\n\n```{.r .cell-code}\ngg_spec.ar <- function(x, log = \"yes\", ...){\n\tspec = spec.ar(x, plot = FALSE, ...)\n\ty = spec$spec\n\ty = switch(log,\n\t\t\t   yes = log(y),\n\t\t\t   no = y,\n\t\t\t   10 * log10(y))\n\tspec.matrix <- cbind.data.frame(freq = spec$freq, y = y)\n\tggplot(spec.matrix, aes(x=freq,y=y)) + geom_line()\n}\np1 = autoplot(AirPassengers) +\n\tlabs(title = \"1. Nombre de passagers aériens mensuel\", y = \"Nombre\")\nspec_b = gg_spec.ar(AirPassengers) + labs(title = \"B.\", y = NULL)\np2 = autoplot(ldeaths) +\n\tlabs(title = \"2. Nombre de décès de maladies pulmonaires au Royaume-Uni\",\n\t\t y = \"Nombre\")\nspec_d = gg_spec.ar(ldeaths) + labs(title = \"D.\", y = NULL)\np3 = autoplot(UKDriverDeaths) +\n\tlabs(title = \"3. Nombre de conducteurs de voitures tués au RU\", y = \"Nombre\")\nspec_a = gg_spec.ar(UKDriverDeaths) + labs(title = \"A.\", y = NULL)\np4 = autoplot(UKgas) +\n\tlabs(title = \"4. Consommation trimestrielle de gaz au Royaume-Uni\")\nspec_c = gg_spec.ar(UKgas) + labs(title = \"C.\", y = NULL)\npatchwork::wrap_plots(p1, p2, p3, p4, spec_a, spec_b, spec_c, spec_d,\n\t\t\t\t\t  ncol = 2)\n```\n:::\n\n\n### Spectres théoriques (voir TP)\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-18-1.pdf)\n:::\n:::\n\n\n\n# Transformation de la série\n\n### Stabilisation de variance\n\nLorsque la variance de la série varie avec le niveau (signe hétéroscédasticité) il peut être utile de transformer la série.\n\n. . .\n\nUne famille de transformation possible est la transformation de Box-Cox (`forecast::BoxCox()` ou `fabletools::box_cox()`):\n$$\nf_\\lambda(x)=\\begin{cases}\n\\log(x)&\\text{ si }\\lambda=0\\\\\n\\frac{sign(x)|x|^\\lambda -1}{\n\\lambda\n}&\\text{ si }\\lambda\\ne0\n\\end{cases}\n$$\nRmq : $sign(x)$ permet de prendre en compte les séries négatives contrairement à la transformation initiale (voir Bickel, P. J., & Doksum, K. A. (1981))\n\n. . .\n\nTransformation en log plus interprétable (analyse en évolution)\n\n. . .\n\nIl existe des méthodes de sélection automatique de $\\lambda$ : `forecast::BoxCox.lambda()` ou `feasts::guerrero()`.\n\n### Exemple {.allowframebreaks}\n\n\\footnotesize\n\n::: {.cell}\n\n```{.r .cell-code}\n(autoplot(BoxCox(UKgas, 1))  +\nlabs(y = NULL, title = expression(lambda~\"=1\"))  +\nautoplot(BoxCox(UKgas, 0))  +\nlabs(y = NULL, title = expression(lambda~\"=0\")) ) / (\nautoplot(BoxCox(UKgas, -0.5)) +\nlabs(y = NULL, title = expression(lambda~\"=-0.5\")) +\nautoplot(BoxCox(UKgas, BoxCox.lambda(UKgas))) +\nlabs(y = NULL, title = expression(lambda~\"=-0.45\")) \n) + plot_annotation(title = \"Consommation trimestrielle de gaz au Royaume-Uni\")\n```\n\n::: {.cell-output-display}\n![](2_Analyse_Graphique_files/figure-beamer/unnamed-chunk-19-1.pdf)\n:::\n:::\n\n\n\n### En prévision\n\nSi on utilise la transformation de Box-Cox en prévision, il faudra alors utiliser la transformation inverse (`forecast::InvBoxCox()` ou `fabletools::inv_box_cox()`) pour calculer les prévisions de la série initiale :\n$$\nf^{-1}_\\lambda(x) =\n\\begin{cases}\n\\exp(x) & \\text{ si }\\lambda=0\\\\\n\\text{sign}(\\lambda x + 1)|\\lambda x+1|^{1/\\lambda} & \\text{ si }\\lambda\\ne0\n\\end{cases}\n$$\n\n. . .\n\n\\bcattention Mais l'inverse de la prévision ne sera pas égale à la moyenne de la distribution des prévisions (mais généralement à la médiane)\n\n. . .\n\nSi médiane non adaptée (par exemple agrégation de prévisions), il faut faire une correction du biais :\n$$\n\\widetilde {f^{-1}_\\lambda}(x) =\n\\begin{cases}\n\\exp(x)\\left[1+\\frac{\\sigma^2_h}{2}\\right] & \\text{ si }\\lambda=0\\\\\n\\text{sign}(\\lambda x + 1)|\\lambda x+1|^{1/\\lambda} \n\\left[1+\\frac{\\sigma^2_h(1-\\lambda)}{2(\\lambda x + 1)^{2\\lambda}}\\right]& \\text{ si }\\lambda\\ne0\n\\end{cases}\n$$\nVoir https://aqlt.github.io/formation/{{< var repo-github>}}/backcasttransform\n\n# Conclusion\n\n### Analyse graphique indispensable\n\nAvant d'appliquer tout modèle l'analyse graphique est indispensable ! Permet d'identifier :\n\n- les différentes composantes (saisonnalité ? tendance ?)\n\n- les points atypiques\n\n- les signes d'hétéroscédasticité\n\n\nDe nombreux types de graphiques vous permettent d'étudier différemment la série\n\nPour stabiliser la variance, une transformation de la série peut être nécessaire de transformer la série (log ou Box-Cox)\n\n\n### Bibliographie\n\nAragon, Y. (2011), *Séries temporelles avec R. Méthodes et cas*, Springer.\n\nBrockwell, P. J. and Davis, R. A. (1991) *Time Series: Theory and Methods*. Second edition. Springer.\n\nAvec `ts()` :\n\nHyndman, R.J., & Athanasopoulos, G. (2018) *Forecasting: principles and practice*, 2nd edition, OTexts: Melbourne, Australia. OTexts.com/fpp2. Accessed on oct. 2023.\n\nSur `tsibble` :\n\nHyndman, R.J., & Athanasopoulos, G. (2021) *Forecasting: principles and practice*, 3rd edition, OTexts: Melbourne, Australia. OTexts.com/fpp3. Accessed on oct. 2023.\n",
    "supporting": [
      "2_Analyse_Graphique_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}